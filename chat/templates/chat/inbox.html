{% extends "base.html" %}
{% load static %}

{% block title %}
    {{ page_title }}
{% endblock title %}

{% block content %}
<div class="form-container">
    <div class="welcome-card">
        <h2 class="page-title">Message Inbox</h2>
        <p class="page-subtitle">Your active conversations.</p>

        {% if threads %}
            <div class="inbox-list">
                {% for thread in threads %}
                    {% comment %} 
                        Determine who the other user is for display purposes. 
                    {% endcomment %}
                    {% with other_user=thread.user1 %}
                        {% if other_user == request.user %}
                            {% with other_user=thread.user2 %}
                            {% endwith %}
                        {% endif %}
                    {% endwith %}

                    <a href="{% url 'thread' thread.id %}" class="inbox-item">
                        <div class="inbox-avatar-wrapper">
                            {% comment %} 
                                CRITICAL FIX: Check if the user has uploaded a custom avatar.
                                If not, use the default placeholder image. 
                            {% endcomment %}
                            {% if other_user.profile.avatar %}
                                <img src="{{ other_user.profile.avatar.url }}" 
                                     alt="{{ other_user.username }}'s avatar" 
                                     class="inbox-avatar">
                            {% else %}
                                <img src="{% static 'accounts/default-profile.png' %}" 
                                     alt="{{ other_user.username }}'s default avatar" 
                                     class="inbox-avatar default-avatar">
                            {% endif %}
                        </div>
                        <div class="inbox-info">
                            <h4 class="inbox-username">{{ other_user.username }}</h4>
                            <p class="inbox-last-message">
                                {% with last_message=thread.messages.last %}
                                    {% if last_message %}
                                        {% if last_message.sender == request.user %}
                                            <span class="sender-hint">You: </span>
                                        {% endif %}
                                        {{ last_message.content|truncatechars:40 }}
                                        <span class="inbox-timestamp">{{ last_message.timestamp|timesince }} ago</span>
                                    {% else %}
                                        Start a conversation.
                                    {% endif %}
                                {% endwith %}
                            </p>
                        </div>
                    </a>
                {% endfor %}
            </div>
        {% else %}
            <div class="no-posts-message">
                <p>You don't have any active conversations yet.</p>
                <p>Use the Search page to find someone to chat with!</p>
            </div>
        {% endif %}

    </div>
</div>
{% endblock content %}